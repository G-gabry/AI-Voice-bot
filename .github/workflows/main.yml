name: ğŸš€ EC2 DeploymentGabryomaralii

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      EC2_USER: ec2-user
      EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}

    steps:
      - name: ğŸ” Set up SSH key
        run: |
          echo "$EC2_SSH_KEY" > ec2-key.pem
          chmod 400 ec2-key.pem

      - name: ğŸš€ Deploy via SSH
        run: |
          echo "ğŸ“¡ Connecting to EC2..."
          ssh -v -o StrictHostKeyChecking=no -i ec2-key.pem $EC2_USER@ec2-54-221-147-33.compute-1.amazonaws.com '
            echo "âœ… Connected to EC2"

            GITHUB_REPO="'"${{ github.repository }}"'"
            echo "ğŸ“¦ Repo: $GITHUB_REPO"

            echo "ğŸ”§ Updating system"
            sudo yum update -y || { echo "âŒ yum update failed"; exit 1; }

            echo "ğŸ“¦ Installing base packages"
            sudo yum install -y docker git python3-pip ffmpeg || { echo "âŒ package install failed"; exit 1; }

            echo "ğŸš€ Starting Docker"
            sudo systemctl enable docker || { echo "âŒ docker enable failed"; exit 1; }
            sudo systemctl start docker || { echo "âŒ docker start failed"; exit 1; }

            echo "ğŸ”„ Cloning or updating repo"
            if [ ! -d "voice-chatbot" ]; then
              git clone https://github.com/$GITHUB_REPO.git voice-chatbot || { echo "âŒ git clone failed"; exit 1; }
            else
              cd voice-chatbot && git pull origin main && cd .. || { echo "âŒ git pull failed"; exit 1; }
            fi

            echo "ğŸ§¹ Cleaning up Docker"
            docker system prune -af --volumes || true

            echo "ğŸ³ Running Docker container"
            cd voice-chatbot
            sudo docker stop voicebot || true
            sudo docker rm voicebot || true
            sudo docker build -t voicebot . || { echo "âŒ docker build failed"; exit 1; }
            sudo docker run -d -p 8000:8000 --name voicebot voicebot || { echo "âŒ docker run failed"; exit 1; }

            echo "âœ… Deployment finished!"
          '
