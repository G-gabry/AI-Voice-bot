name: 🚀 Deploy Voice Chatbot to EC2

on:
  push:
    branches: [ main ]  # Trigger on push to main branch

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v3

    - name: 🔐 Set up SSH key
      run: |
        echo "$EC2_SSH_KEY" > ec2-key.pem
        chmod 400 ec2-key.pem

    - name: 🚀 Deploy via SSH
      run: |
        ssh -o StrictHostKeyChecking=no -i ec2-key.pem $44.201.146.97 << 'EOF'
          sudo apt update
          sudo apt install -y docker.io git python3-pip ffmpeg

          # Pull latest code
          if [ ! -d "voice-chatbot" ]; then
            git clone https://github.com/${{ github.repository }}.git voice-chatbot
          else
            cd voice-chatbot && git pull origin main && cd ..
          fi

          cd voice-chatbot

          # Stop previous container
          docker stop voicebot-app || true
          docker rm voicebot-app || true

          # Build and run updated container
          docker build -t voicebot-app .
          docker run -d -p 8000:8000 --name voicebot-app voicebot-app
        EOF

    env:
      EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
      EC2_USER: ${{ secrets.EC2_USER }}
      EC2_HOST:44.201.146.97
